version: '3.8'

services:
  postgres:
    image: postgres:16  # ✅ 推荐稳定版（18 仍是开发版，生产环境慎用）
    container_name: postgres-prod
    restart: unless-stopped
    environment:
      - POSTGRES_PASSWORD=${DB_ADMIN_PASSWORD}      # 从 .env.prod 读取
      - POSTGRES_USER=${DB_ADMIN_USER:-postgres}
      - TZ=Asia/Shanghai
      - PGPASSWORD=${DB_ADMIN_PASSWORD}
    volumes:
      - postgres_data:/var/lib/postgresql            # ✅ PostgreSQL 18+ 正确挂载点
      - ./init-scripts:/docker-entrypoint-initdb.d   # 启动时执行初始化脚本
      - ./logs:/var/log/postgresql                   # 日志持久化
    ports:
      - "${DB_PORT:-5432}:5432"                       # 可配置端口
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${DB_ADMIN_USER:-postgres}"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 40s
    deploy:  # Docker Swarm 部署配置（可选）
      resources:
        limits:
          cpus: '2.0'
          memory: 4G
        reservations:
          cpus: '0.5'
          memory: 1G
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "3"
        tag: "postgres-prod"

  # 可选：PostgreSQL 监控导出器（用于 Prometheus + Grafana）
  # postgres-exporter:
  #   image: prometheuscommunity/postgres-exporter:v0.13.2
  #   container_name: postgres-exporter
  #   restart: unless-stopped
  #   environment:
  #     - DATA_SOURCE_NAME=postgresql://${DB_ADMIN_USER:-postgres}:${DB_ADMIN_PASSWORD}@postgres:5432/postgres?sslmode=disable
  #   ports:
  #     - "9187:9187"
  #   depends_on:
  #     - postgres
  #   networks:
  #     - backend
  #   healthcheck:
  #     test: ["CMD", "wget", "--quiet", "--tries=1", "http://localhost:9187/metrics", "-O", "/dev/null"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # 可选：pgAdmin（生产环境建议通过跳板机访问，不直接暴露）
  # pgadmin:
  #   image: dpage/pgadmin4:8.5
  #   container_name: pgadmin
  #   restart: unless-stopped
  #   environment:
  #     - PGADMIN_DEFAULT_EMAIL=${PGADMIN_DEFAULT_EMAIL:-admin@yourcompany.com}
  #     - PGADMIN_DEFAULT_PASSWORD=${PGADMIN_DEFAULT_PASSWORD}
  #     - PGADMIN_LISTEN_PORT=80
  #   volumes:
  #     - pgadmin_data:/var/lib/pgadmin
  #   ports:
  #     - "${PGADMIN_PORT:-8080}:80"  # 生产环境建议用反向代理+TLS
  #   depends_on:
  #     - postgres
  #   networks:
  #     - backend
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: "50m"
  #       max-file: "2"

volumes:
  postgres_data:                    # Docker 管理的命名卷（推荐）
    driver: local
    driver_opts:
      type: none
      device: /data/postgres       # 挂载到宿主机特定目录（便于备份）
      o: bind
  pgadmin_data:

networks:
  backend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/24